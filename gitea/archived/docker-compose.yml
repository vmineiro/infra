version: "3"

networks:
  gitea:
    driver: bridge

volumes:
  gitea_data:
    driver: local
  gitea_config:
    driver: local
  gitea_runner_data:
    driver: local

services:
  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    restart: always

    environment:
      # Minimal config - let web UI handle everything
      - GITEA__server__SSH_PORT=2222
      # CRITICAL: Enable Gitea Actions for CI/CD
      - GITEA__actions__ENABLED=true

    volumes:
      - gitea_data:/data
      - gitea_config:/etc/gitea
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

    ports:
      - "3000:3000"  # HTTP
      - "2222:2222"  # SSH

    networks:
      - gitea

    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  gitea-runner:
    image: gitea/act_runner:latest
    container_name: gitea-runner
    restart: always

    depends_on:
      gitea:
        condition: service_healthy

    environment:
      - GITEA_INSTANCE_URL=http://gitea:3000
      - GITEA_RUNNER_NAME=macbook-air-runner
      - GITEA_RUNNER_LABELS=ubuntu-latest:docker://node:20-bullseye,ubuntu-22.04:docker://node:20-bullseye
      - GITEA_RUNNER_REGISTRATION_TOKEN=

    volumes:
      - gitea_runner_data:/data
      - /var/run/docker.sock:/var/run/docker.sock

    networks:
      - gitea

    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
